# Istio Integration

OpenUnison works with Istio out-of-the-box.  It's been tested with Istio's side cars and can be deployed to use Istio as an `Ingress` controller.  When deploying with Istio, your helm chart will create the appropriate `Gateway`, `VirtualService`, and `Destination` objects depending on your configuration choices.  The `Service` objects will be named appropriately for Kiali to visualize the connections.

## Deployment

First, add a label to the `openunison` namespace so Istio knows to add the envoy side cars:

```
kubectl label namespace openunison istio-injection=enabled
```

In your values.yaml, set:

1. `network.ingress_type: istio` - Tells the helm chart to create the correct objects
2. `network.ingress_certificate: ou-tls-certificate` - The value should be the name of the `Secret` in the namespace where Istio is running (ie `istio-system`) that stores the certificate Istio should use to serve access to OpenUnison
3. `network.istio.selectors` - List of labels that should be used to associate the `Gateway` with an istio controller.  Default is `istio: ingressgateway`
4. `network.force_redirect_to_tls: false` - Stops OpenUnison from redirecting http to https, instead making the envoy sidecar proxy the TLS termination point

Once deployed, access OpenUnison via the URL you specified in `network.openunison_host` and access your portal!

## Kiali Integration

Add SSO for your Kiali deployment by following the instructions for [Kiali](../../applications/kiali) in the `Applications` section of these docs.

## Known Issues

### Impersonation and `kubectl exec`

If using OpenUnison in impersonation mode, such as with a cloud hosted cluster, Istio can't be the TLS termination point because Envoy doesn't support the SPDY protocol used by `kubectl exec`, `port-forward`, and `cp`.  The helm chart will automatically setup passthrough TLS to support these functions.  This means that you won't get most of the telemetry on these functions to the oidc-proxy that deploys with OpenUnison.  The `kubectl` commands generated by the portal will automatically embed the correct certificate.

### check-certs-orchestra `Pod` Error

The `check-certs-orchestra` `Job` runs every day to check for certificates that need to renew.  With Istio enabled it often completes with an error.  The Job often runs so quickly that the sidecar isn't don't initializing in time.  